# Environment Configuration

This document explains how to configure environment variables for different deployment environments.

## Environment Files

### `.env` - Main Configuration

Copy the example environment file and customize as needed:

```bash
# Copy environment template
cp .env.example .env

# Edit .env file with your values
# Required changes:
# - JWT_SECRET: Replace 'change-me-32-chars-min' with a secure 32+ character secret
# - DATABASE_PASSWORD: Set if using AWS RDS instead of local DB
```

### `.env.localstack` - Auto-generated LocalStack URLs

This file is automatically generated by `make setup-dev` and contains SQS queue URLs for LocalStack:

```bash
SQS_ENDPOINT=http://localhost:4566
SQS_INGEST_QUEUE_URL=http://localhost.localstack.cloud:4566/queue/us-east-1/000000000000/ingest-queue
SQS_INGEST_DLQ_URL=http://localhost.localstack.cloud:4566/queue/us-east-1/000000000000/ingest-dlq
APP_SQS_INGEST_QUEUE_URL=http://localhost.localstack.cloud:4566/queue/us-east-1/000000000000/ingest-queue
APP_SQS_INGEST_DLQ_URL=http://localhost.localstack.cloud:4566/queue/us-east-1/000000000000/ingest-dlq
```

> **Note**: This file is regenerated each time you run queue setup scripts.

## Environment Variables Reference

### JWT Authentication (Required)

```bash
JWT_SECRET=your-secure-32-character-minimum-secret-key
```

**Requirements:**
- Minimum 32 characters
- Use a cryptographically secure random string
- Same secret must be used across all application instances

### Local Database (Docker Compose)

```bash
LOCAL_DB_HOST=localhost
LOCAL_DB_PORT=5432
LOCAL_DB_NAME=nauta_dev
LOCAL_DB_USERNAME=nauta
LOCAL_DB_PASSWORD=nauta123
```

These match the PostgreSQL container configuration in `docker-compose.yml`.

### AWS RDS Database (Production/Staging)

```bash
DATABASE_HOST=your-rds-endpoint.region.rds.amazonaws.com
DATABASE_PORT=5432
DATABASE_NAME=postgres
DATABASE_USERNAME=postgres
DATABASE_PASSWORD=your-secure-database-password
```

Used when running with `SPRING_PROFILES_ACTIVE=dev-aws`.

### AWS SQS Configuration

For LocalStack (automatically configured):
```bash
SQS_ENDPOINT=http://localhost:4566
SQS_INGEST_QUEUE_URL=http://localhost:4566/000000000000/ingest-queue
SQS_INGEST_DLQ_URL=http://localhost:4566/000000000000/ingest-dlq
```

For AWS (production):
```bash
# SQS_ENDPOINT is not set (uses default AWS endpoints)
# Queue URLs are provided by AWS after creation
SQS_INGEST_QUEUE_URL=https://sqs.region.amazonaws.com/account/queue-name
SQS_INGEST_DLQ_URL=https://sqs.region.amazonaws.com/account/dlq-name
```

## Environment Loading by Profile

### Local Profile (`SPRING_PROFILES_ACTIVE=local`)

```bash
make run-local
```

Loads in order:
1. `.env` (main configuration)
2. `.env.localstack` (LocalStack-specific URLs)

### Dev-AWS Profile (`SPRING_PROFILES_ACTIVE=dev-aws`)

```bash
make run-dev-aws
```

Loads:
1. `.env` (main configuration)
2. AWS credentials from SSO/profile

## Validation Commands

### Check Environment Variables

```bash
make check-env
```

Shows:
- ✅ .env found with redacted sensitive values
- ✅ .env.localstack found with actual URLs
- ❌ Missing files or variables

### Validate Environment Setup

```bash
make validate-local
```

Checks:
- Docker containers are running
- LocalStack health endpoint responds
- PostgreSQL accepts connections
- SQS queues exist and are accessible

## Security Best Practices

1. **Never commit `.env` files** - They're in `.gitignore`
2. **Use strong JWT secrets** - Generate with `openssl rand -base64 32`
3. **Rotate secrets regularly** - Especially in production environments
4. **Use AWS SSO** - For development against AWS resources
5. **Environment-specific secrets** - Different secrets per environment

## Troubleshooting

### JWT_SECRET not found
```bash
grep JWT_SECRET .env
# Should show: JWT_SECRET=your-secret-key
```

### Database connection issues
```bash
# Check if .env has correct database name
grep LOCAL_DB_NAME .env
# Should show: LOCAL_DB_NAME=nauta_dev (not 'nauta')
```

### SQS endpoint issues
```bash
# Regenerate LocalStack configuration
make clean-queues && make setup-dev
```

See [TROUBLESHOOTING.md](TROUBLESHOOTING.md) for more detailed diagnostics.