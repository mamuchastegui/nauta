# Project Guide

## Environment Setup
- **Quick start**: `make setup-dev` (PostgreSQL + LocalStack + SQS queues)
- **Run local**: `make run-local` (local profile with Docker services)
- **Run AWS dev**: `make run-dev-aws` (dev-aws profile with RDS + AWS SQS)
- **Validate**: `make validate-local` (check all services healthy)

## Build & Test
- Build: `./gradlew clean build`
- Test: `./gradlew test`
- Run: Use `make run-local` or `make run-dev-aws` (not raw `./gradlew bootRun`)

## Environment Files
- Copy `.env.example` to `.env` and set `JWT_SECRET` (32+ chars)
- `.env.localstack` is auto-generated by setup scripts
- See [docs/ENVIRONMENT.md](../docs/ENVIRONMENT.md) for details

## Architecture
- **Hexagonal architecture** (ports & adapters)
- **Domain**: Business entities with validation (e.g., `ContainerRef` with ISO 6346)
- **Application**: Use cases (`IngestService`)
- **Infrastructure**: Adapters (REST, SQS, JDBC, JWT)

## Technology Stack
- **JDK**: 21 (LTS), **Gradle**: 8.10
- **Kotlin**: 2.0.x, **Spring Boot**: 3.3.5
- **Database**: PostgreSQL 15 (local Docker + AWS RDS)
- **Messaging**: SQS (LocalStack + AWS)
- **Authentication**: JWT HS256 with tenant scoping

## Documentation Structure
- **Main README**: Overview, quick start, architecture
- **docs/ENVIRONMENT.md**: Environment variables and configuration
- **docs/API_TESTING.md**: JWT tokens, API endpoints, testing scenarios
- **docs/DEVELOPMENT.md**: All make commands, Docker operations, workflows
- **docs/TROUBLESHOOTING.md**: Common issues and solutions

## Code Style
- All source code, comments, docstrings, log messages, and variable names **must be in English**
- Follow Kotlin idioms and standard naming conventions
- Avoid abbreviations unless widely accepted (e.g., ID, URL, SQS, JWT)
- Use value classes for business identifiers with validation

## Quality Assurance
- Lint/format: `./gradlew ktlintCheck ktlintFormat`
- Static analysis: `./gradlew detekt`
- Do not modify: `**/migrations/**`, `**/generated/**`

## Development Principles
- **Hexagonal architecture**: Domain at center, infrastructure at edges
- **Multi-tenancy**: All data operations scoped by `tenant_id`
- **Endpoint agnostic**: SQS scripts work with both domain and path strategies
- **Idempotent operations**: Setup scripts can be re-run safely
- **Environment isolation**: Clear separation between local/dev/prod

## Common Commands
```bash
# Environment
make setup-dev         # Full environment setup
make validate-local    # Validate all services
make clean-env         # Clean and reset
make check-env         # Check environment variables

# Application
make run-local         # Local development
make run-dev-aws       # AWS development
make test              # Run tests

# Troubleshooting
make reset-local       # Complete reset
./scripts/setup-queues.sh dev --test  # Test SQS flow
```

## SQS LocalStack Strategy
- LocalStack 3.0 ignores `SQS_ENDPOINT_STRATEGY: path` setting
- Scripts are **endpoint agnostic** - extract endpoint from each QueueUrl
- Support both domain (`localhost.localstack.cloud`) and path (`localhost:4566`) strategies
- See [docs/TROUBLESHOOTING.md](../docs/TROUBLESHOOTING.md) for SQS issues

## Post-patch Checklist
- [ ] Update relevant documentation in `docs/` if behavior changes
- [ ] Test both `make run-local` and `make validate-local`
- [ ] Verify SQS queue setup with `./scripts/setup-queues.sh dev --test`
- [ ] Check that JWT authentication still works
- [ ] Update this CLAUDE.md if workflow changes
